#!/bin/bash
#SBATCH --partition=gpu_h100
#SBATCH --gpus=1
#SBATCH --job-name=eva_clip_embeddings
#SBATCH --time=02:00:00
#SBATCH --output=./slurm_out/embeddings_%j.out
#SBATCH --error=./slurm_out/embeddings_%j.err
#SBATCH --mem=32GB
#SBATCH --cpus-per-task=8

# Exit if an error occurs
set -e

echo "ğŸš€ Starting EVA-CLIP Embedding Extraction Job"
echo "=============================================="
echo "Job ID: $SLURM_JOB_ID"
echo "Node: $SLURMD_NODENAME"
echo "Date: $(date)"
echo "Working directory: $(pwd)"

# Create output directory if it doesn't exist
mkdir -p slurm_out
mkdir -p embeddings

# Load modules
echo "ğŸ“¦ Loading modules..."
module purge
module load 2024
module load Miniconda3/24.7.1-0
module load CUDA/12.6.0

# Activate your conda environment
echo "ğŸ Activating conda environment..."
source activate eva_clip_env


# Show memory and disk usage
echo "ğŸ’¾ System resources:"
echo "   CPU cores: $SLURM_CPUS_PER_TASK"
echo "   Memory: $SLURM_MEM_PER_NODE MB"
echo "   Available disk: $(df -h . | tail -1 | awk '{print $4}')"

# Run the embedding extraction
echo ""
echo "ğŸ§  Starting embedding extraction..."
echo "=============================================="

python src/modules/extract_embeddings_g.py

# Check if extraction was successful
if [ $? -eq 0 ]; then
    echo ""
    echo "âœ… Embedding extraction completed successfully!"
    echo "ğŸ“ Output files:"
    ls -lh embeddings/
    echo "ğŸ“Š Total size: $(du -sh embeddings/ | cut -f1)"
else
    echo "âŒ Embedding extraction failed!"
    exit 1
fi

echo ""
echo "ğŸ‰ Job completed at: $(date)"
echo "â±ï¸ Total runtime: $SECONDS seconds"