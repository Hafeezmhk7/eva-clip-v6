#!/bin/bash
#SBATCH --job-name=blip3o_recall_eval
#SBATCH --partition=gpu_h100
#SBATCH --nodes=1
#SBATCH --gpus=1
#SBATCH --cpus-per-gpu=18
#SBATCH --time=2:00:00
#SBATCH --mem=0
#SBATCH --output=./slurm_out/blip3o_recall_%j.out
#SBATCH --error=./slurm_out/blip3o_recall_%j.err

# =============================================================================
# BLIP3-o Enhanced Patch-Level Recall Evaluation Job
# Tests both CLIP baseline and your trained enhanced BLIP3-o model on COCO
# =============================================================================

echo "üîç BLIP3-o Enhanced Patch-Level Recall Evaluation"
echo "================================================="

# Setup environment
module purge
module load 2024
module load Miniconda3/24.7.1-0
module load CUDA/12.6.0

source activate eva_clip_env

# Updated Configuration for your trained model
COCO_ROOT="./data/coco"
BLIP3O_MODEL_PATH="./checkpoints/blip3o_patch_pure_13259292_20250723_063221"
NUM_SAMPLES=1000
DEVICE="cuda"
K_VALUES="1 5 10"
NUM_INFERENCE_STEPS=50

# Setup temp directories for model cache
export USER=$(whoami)
export JOB_ID=${SLURM_JOB_ID}
export JOB_TEMP="/scratch-local/${USER}.${JOB_ID}/blip3o_recall"

export TORCH_HOME="${JOB_TEMP}/torch"
export HF_HOME="${JOB_TEMP}/huggingface"
export TRANSFORMERS_CACHE="${JOB_TEMP}/transformers"

mkdir -p "${TORCH_HOME}" "${HF_HOME}" "${TRANSFORMERS_CACHE}"
mkdir -p ./slurm_out ./results

echo "Enhanced Evaluation Configuration:"
echo "  COCO Root: $COCO_ROOT"
echo "  BLIP3-o Model: $BLIP3O_MODEL_PATH"
echo "  Model Type: Enhanced Patch-Level DiT"
echo "  Training Mode: Pure training (enhanced)"
echo "  Samples: $NUM_SAMPLES"
echo "  K values: $K_VALUES"
echo "  Inference steps: $NUM_INFERENCE_STEPS"
echo "  Device: $DEVICE"
echo "  Job ID: $JOB_ID"
echo "  Node: $SLURMD_NODENAME"

# Verify paths exist
echo ""
echo "üîç Verifying paths..."
echo "==================="

if [ ! -d "$COCO_ROOT" ]; then
    echo "‚ùå ERROR: COCO data not found at $COCO_ROOT"
    exit 1
fi

if [ ! -f "$COCO_ROOT/annotations/captions_val2017.json" ]; then
    echo "‚ùå ERROR: COCO annotations not found"
    exit 1
fi

if [ ! -d "$COCO_ROOT/images/val2017" ]; then
    echo "‚ùå ERROR: COCO images not found"
    exit 1
fi

if [ ! -d "$BLIP3O_MODEL_PATH" ]; then
    echo "‚ùå ERROR: BLIP3-o model not found at $BLIP3O_MODEL_PATH"
    echo "   Available checkpoints:"
    ls -la ./checkpoints/ 2>/dev/null || echo "   No checkpoints found"
    exit 1
fi

# Check for enhanced model files
ENHANCED_CONFIG_FILE=""
if [ -f "$BLIP3O_MODEL_PATH/enhanced_training_config.json" ]; then
    ENHANCED_CONFIG_FILE="enhanced_training_config.json"
    echo "‚úÖ Enhanced training config found"
elif [ -f "$BLIP3O_MODEL_PATH/config.json" ]; then
    ENHANCED_CONFIG_FILE="config.json"
    echo "‚úÖ Standard config found"
elif [ -f "$BLIP3O_MODEL_PATH/blip3o_model_config.json" ]; then
    ENHANCED_CONFIG_FILE="blip3o_model_config.json"
    echo "‚úÖ BLIP3-o config found"
else
    echo "‚ùå ERROR: No config file found in BLIP3-o model directory"
    echo "   Model directory contents:"
    ls -la "$BLIP3O_MODEL_PATH"
    exit 1
fi

# Check for model weights
WEIGHT_FILE=""
if [ -f "$BLIP3O_MODEL_PATH/pytorch_model.bin" ]; then
    WEIGHT_FILE="pytorch_model.bin"
    echo "‚úÖ PyTorch weights found"
elif [ -f "$BLIP3O_MODEL_PATH/model.safetensors" ]; then
    WEIGHT_FILE="model.safetensors"
    echo "‚úÖ SafeTensors weights found"
elif [ -f "$BLIP3O_MODEL_PATH/pytorch_model.safetensors" ]; then
    WEIGHT_FILE="pytorch_model.safetensors"
    echo "‚úÖ PyTorch SafeTensors weights found"
else
    echo "‚ùå ERROR: No model weights found in BLIP3-o model directory"
    echo "   Model directory contents:"
    ls -la "$BLIP3O_MODEL_PATH"
    exit 1
fi

echo "‚úÖ COCO data verified"
echo "‚úÖ Enhanced BLIP3-o model verified"

# Show enhanced model info
echo ""
echo "üìä Enhanced Model Information:"
echo "============================="
echo "Model path: $BLIP3O_MODEL_PATH"
echo "Config file: $ENHANCED_CONFIG_FILE"
echo "Weight file: $WEIGHT_FILE"
echo ""
echo "Model contents:"
ls -la "$BLIP3O_MODEL_PATH"

# Show training info if available
if [ -f "$BLIP3O_MODEL_PATH/enhanced_training_config.json" ]; then
    echo ""
    echo "Enhanced training summary:"
    python3 -c "
import json
try:
    with open('$BLIP3O_MODEL_PATH/enhanced_training_config.json') as f:
        config = json.load(f)
    
    print(f\"  Training mode: {config.get('training_strategy', {}).get('mode', 'unknown')}\")
    print(f\"  Architecture: {config.get('architecture', 'unknown')}\")
    print(f\"  Enhanced: {config.get('enhanced_version', False)}\")
    
    # Enhanced hyperparameters
    if 'enhanced_hyperparameters' in config:
        hp = config['enhanced_hyperparameters']
        print(f\"  Epochs trained: {hp.get('num_epochs', 'unknown')}\")
        print(f\"  Learning rate: {hp.get('learning_rate', 'unknown')}\")
        print(f\"  LR scheduler: {hp.get('lr_scheduler_type', 'unknown')}\")
        print(f\"  Contrastive weight: {hp.get('contrastive_weight', 'unknown')}\")
        print(f\"  Convergence optimized: {hp.get('optimized_for_convergence', False)}\")
    
    # Model config
    if 'model_config' in config:
        mc = config['model_config']
        print(f\"  Model size: {mc.get('hidden_size', 'unknown')}D\")
        print(f\"  Layers: {mc.get('num_hidden_layers', 'unknown')}\")
        print(f\"  Heads: {mc.get('num_attention_heads', 'unknown')}\")
        
except Exception as e:
    print(f\"  Could not parse config: {e}\")
"
elif [ -f "$BLIP3O_MODEL_PATH/training_summary.json" ]; then
    echo ""
    echo "Training summary:"
    cat "$BLIP3O_MODEL_PATH/training_summary.json" | head -20
fi

# Verify evaluation script exists
EVAL_SCRIPT="eval_blip3o_patch_recall.py"
if [ ! -f "$EVAL_SCRIPT" ]; then
    echo "‚ùå ERROR: Evaluation script not found: $EVAL_SCRIPT"
    echo "   Make sure the script is in the current directory"
    exit 1
fi

echo "‚úÖ Evaluation script verified: $EVAL_SCRIPT"

# Run enhanced recall evaluation
echo ""
echo "üöÄ Starting Enhanced BLIP3-o Recall Evaluation..."
echo "================================================"
echo "This will test:"
echo "  1. üéØ CLIP ViT-L/14 baseline (verification)"
echo "  2. ü§ñ Your enhanced trained BLIP3-o patch model"
echo ""
echo "Expected enhanced performance:"
echo "  ‚Ä¢ CLIP baseline R@1: ~58-60% (literature)"
echo "  ‚Ä¢ Enhanced BLIP3-o R@1: Should match/exceed baseline"
echo "  ‚Ä¢ Enhanced features: Better convergence & alignment"
echo ""

EVAL_START_TIME=$(date +%s)

# Run the correct evaluation script with proper parameters
python eval_blip3o_patch_recall.py \
    --coco_root "$COCO_ROOT" \
    --model_path "$BLIP3O_MODEL_PATH" \
    --num_samples $NUM_SAMPLES \
    --device $DEVICE \
    --num_inference_steps $NUM_INFERENCE_STEPS \
    --save_results "results/blip3o_enhanced_recall_evaluation_${JOB_ID}.json"

EXIT_CODE=$?
EVAL_END_TIME=$(date +%s)
EVAL_DURATION=$((EVAL_END_TIME - EVAL_START_TIME))

# Enhanced results summary
echo ""
echo "========================================================================"
echo "üìä ENHANCED BLIP3-o RECALL EVALUATION RESULTS"
echo "========================================================================"
echo "Job ID: $JOB_ID"
echo "Node: $SLURMD_NODENAME"
echo "Model: Enhanced Patch-Level DiT"
echo "Training: Pure training with convergence optimization"
echo "Evaluation Duration: $EVAL_DURATION seconds"
echo "Total Runtime: $SECONDS seconds"
echo "Date: $(date)"

if [ $EXIT_CODE -eq 0 ]; then
    echo "Status: ‚úÖ SUCCESS - ENHANCED EVALUATION COMPLETED"
    
    # Find and display results from JSON file
    RESULTS_FILE="results/blip3o_enhanced_recall_evaluation_${JOB_ID}.json"
    if [ -f "$RESULTS_FILE" ]; then
        echo ""
        echo "üìä ENHANCED RESULTS SUMMARY:"
        echo "==========================="
        
        # Parse JSON results and display prominently
        if command -v python3 &> /dev/null; then
            python3 << EOF
import json
import sys

try:
    with open('$RESULTS_FILE', 'r') as f:
        data = json.load(f)
    
    results = data.get('results', {})
    eval_info = data.get('evaluation_info', {})
    
    print()
    print("üéØ ENHANCED RECALL COMPARISON RESULTS:")
    print("-" * 50)
    
    # Check if we have both methods
    clip_results = results.get('clip_baseline', {})
    blip3o_results = results.get('blip3o_patch', {})
    
    if 'error' not in clip_results and 'error' not in blip3o_results:
        # Both methods successful
        clip_r1 = clip_results.get('recall@1', 0) * 100
        clip_r5 = clip_results.get('recall@5', 0) * 100
        clip_r10 = clip_results.get('recall@10', 0) * 100
        
        blip3o_r1 = blip3o_results.get('recall@1', 0) * 100
        blip3o_r5 = blip3o_results.get('recall@5', 0) * 100
        blip3o_r10 = blip3o_results.get('recall@10', 0) * 100
        
        print(f"üìã CLIP BASELINE (ViT-L/14):")
        print(f"   R@1:  {clip_r1:5.1f}% | R@5:  {clip_r5:5.1f}% | R@10: {clip_r10:5.1f}%")
        print()
        print(f"ü§ñ ENHANCED BLIP3-o MODEL:")
        print(f"   R@1:  {blip3o_r1:5.1f}% | R@5:  {blip3o_r5:5.1f}% | R@10: {blip3o_r10:5.1f}%")
        print()
        
        # Performance comparison
        r1_diff = blip3o_r1 - clip_r1
        r1_pct_change = (r1_diff / clip_r1) * 100 if clip_r1 > 0 else 0
        
        print(f"üìà ENHANCED PERFORMANCE ANALYSIS:")
        print(f"   R@1 Difference: {r1_diff:+.1f}% ({r1_pct_change:+.1f}%)")
        
        if r1_diff >= 3:
            print(f"   üéâ OUTSTANDING: Enhanced training highly successful!")
            print(f"   üöÄ Model significantly outperforms CLIP baseline")
            print(f"   ‚úÖ Enhanced convergence optimization worked perfectly")
        elif r1_diff >= 1:
            print(f"   üéâ EXCELLENT: Enhanced BLIP3-o outperforms CLIP!")
            print(f"   ‚úÖ Enhanced training features improved performance")
            print(f"   üéØ Model successfully learned EVA‚ÜíCLIP mapping")
        elif r1_diff >= -1:
            print(f"   ‚úÖ GOOD: Enhanced BLIP3-o matches CLIP performance")
            print(f"   üéØ Model preserves CLIP's retrieval capabilities")
            print(f"   ‚úÖ Enhanced training maintained quality")
        elif r1_diff >= -3:
            print(f"   ‚ö†Ô∏è  ACCEPTABLE: Minor performance drop")
            print(f"   üí° Enhanced features mostly successful")
            print(f"   üí° Consider further fine-tuning")
        else:
            print(f"   ‚ùå CONCERNING: Significant performance drop")
            print(f"   üí° Enhanced model needs architectural improvements")
        
        print()
        
        # Literature comparison
        print(f"üìö Literature Comparison:")
        print(f"   Expected CLIP ViT-L/14 R@1: ~58-60%")
        print(f"   Your CLIP baseline R@1:     {clip_r1:.1f}%")
        
        if clip_r1 >= 58:
            print(f"   ‚úÖ EXCELLENT: Baseline matches literature!")
        elif clip_r1 >= 55:
            print(f"   ‚úÖ GOOD: Close to literature values")
        else:
            print(f"   ‚ö†Ô∏è  LOW: Below expected literature values")
        
        print()
        
        # Enhanced training assessment
        print(f"üöÄ ENHANCED TRAINING ASSESSMENT:")
        print("-" * 40)
        
        if blip3o_r1 >= clip_r1 and clip_r1 >= 55:
            print("üéâ ENHANCED TRAINING SUCCESS!")
            print("   ‚úÖ Enhanced BLIP3-o learned excellent CLIP embeddings")
            print("   ‚úÖ Convergence optimization effective")
            print("   ‚úÖ Pure training mode successful")
            print("   ‚úÖ Retrieval performance preserved or improved")
            print("   üöÄ Ready for deployment or further research")
        elif blip3o_r1 >= clip_r1 - 2 and clip_r1 >= 55:
            print("‚úÖ ENHANCED TRAINING GOOD!")
            print("   ‚úÖ Enhanced BLIP3-o generates reasonable CLIP embeddings")
            print("   ‚úÖ Most enhanced features working well")
            print("   üí° Minor improvements possible with fine-tuning")
        else:
            print("‚ö†Ô∏è  ENHANCED TRAINING NEEDS IMPROVEMENT")
            print("   üí° Consider enhanced hyperparameter tuning")
            print("   üí° Check enhanced convergence metrics")
            print("   üí° Verify enhanced loss components")
    
    else:
        # Handle errors
        if 'error' in clip_results:
            print(f"‚ùå CLIP baseline failed: {clip_results['error']}")
        if 'error' in blip3o_results:
            print(f"‚ùå Enhanced BLIP3-o evaluation failed: {blip3o_results['error']}")
    
    print()
    print(f"üíæ Enhanced evaluation results saved to: $RESULTS_FILE")

except Exception as e:
    print(f"‚ùå Could not parse enhanced results file: {e}")
    sys.exit(1)
EOF
        else
            echo "‚ö†Ô∏è  Python not available to parse results"
            echo "   Results file: $RESULTS_FILE"
        fi
    else
        echo "‚ö†Ô∏è  No results file found"
        echo "   Evaluation may have completed without saving results"
        echo "   Check the output above for inline results"
    fi
    
    echo ""
    echo "‚úÖ ENHANCED BLIP3-o RECALL EVALUATION COMPLETED SUCCESSFULLY"
    
else
    echo "Status: ‚ùå FAILED"
    echo ""
    echo "‚ùå ENHANCED BLIP3-o RECALL EVALUATION FAILED WITH EXIT CODE: $EXIT_CODE"
    echo ""
    echo "üîç Enhanced troubleshooting:"
    echo "   1. Check if COCO data exists and is accessible"
    echo "   2. Verify enhanced BLIP3-o model path and files"
    echo "   3. Ensure GPU memory is sufficient"
    echo "   4. Check Python environment and enhanced dependencies"
    echo "   5. Verify enhanced model compatibility"
    echo "   6. Look for error messages in the output above"
    echo ""
    echo "üìÇ Log files:"
    echo "   Output: ./slurm_out/blip3o_recall_${JOB_ID}.out"
    echo "   Error:  ./slurm_out/blip3o_recall_${JOB_ID}.err"
    echo ""
    echo "üîß Enhanced quick checks:"
    echo "   ‚Ä¢ COCO path: $COCO_ROOT"
    echo "   ‚Ä¢ Enhanced BLIP3-o model: $BLIP3O_MODEL_PATH"
    echo "   ‚Ä¢ Available space: $(df -h . | tail -1 | awk '{print $4}')"
    echo "   ‚Ä¢ Enhanced config: $ENHANCED_CONFIG_FILE"
    echo "   ‚Ä¢ Weight file: $WEIGHT_FILE"
fi

echo ""
echo "========================================================================"
echo "üèÅ ENHANCED EVALUATION SUMMARY"
echo "========================================================================"

# Always show final status prominently
if [ $EXIT_CODE -eq 0 ]; then
    echo "üéâ SUCCESS: Check the enhanced recall results above!"
    echo ""
    echo "üìã What was tested:"
    echo "   ‚úÖ CLIP ViT-L/14 baseline (verification)"
    echo "   ‚úÖ Your enhanced trained BLIP3-o patch model"
    echo ""
    echo "üéØ Enhanced Questions Answered:"
    echo "   ‚Ä¢ Does CLIP baseline match literature? (~58-60% expected)"
    echo "   ‚Ä¢ Does enhanced BLIP3-o preserve/improve recall performance?"
    echo "   ‚Ä¢ How well did enhanced convergence optimization work?"
    echo "   ‚Ä¢ Are enhanced training features effective?"
    echo ""
    echo "üìä Enhanced Next Steps:"
    echo "   ‚Ä¢ Review the enhanced performance comparison above"
    echo "   ‚Ä¢ Check if enhanced results meet your requirements"
    echo "   ‚Ä¢ Use insights to guide further enhanced development"
    echo "   ‚Ä¢ Consider deployment if results are excellent"
else
    echo "‚ùå FAILURE: Check enhanced error messages above and in log files"
    echo ""
    echo "üí° Enhanced troubleshooting:"
    echo "   ‚Ä¢ Enhanced BLIP3-o model path incorrect or files missing"
    echo "   ‚Ä¢ Insufficient GPU memory for enhanced model"
    echo "   ‚Ä¢ Missing enhanced dependencies or environment issues"
    echo "   ‚Ä¢ Enhanced model compatibility problems"
    echo "   ‚Ä¢ COCO dataset path or permissions problems"
fi

echo "========================================================================"

# Cleanup temp cache
if [ -d "${JOB_TEMP}" ]; then
    echo "üßπ Cleaning up temporary cache..."
    rm -rf "${JOB_TEMP}"
fi

echo "üèÅ Enhanced evaluation job completed at $(date)"

exit $EXIT_CODE