2025-07-28 07:16:01,618 - INFO - ðŸš€ Starting CLIP Reproduction with BLIP3-o DiT
2025-07-28 07:16:01,620 - INFO - ================================================================================
2025-07-28 07:16:01,620 - INFO - EXPERIMENT DETAILS:
2025-07-28 07:16:01,620 - INFO -   ðŸ“‹ Task: Reproduce clean CLIP embeddings from EVA embeddings
2025-07-28 07:16:01,620 - INFO -   ðŸ§  Model: BLIP3-o DiT with advanced architecture features
2025-07-28 07:16:01,620 - INFO -   ðŸŽ¯ Target: CLIP embeddings [B, N, 1024]
2025-07-28 07:16:01,620 - INFO -   ðŸŽ® Conditioning: EVA embeddings [B, N, 4096]
2025-07-28 07:16:01,620 - INFO -   ðŸŒŠ Method: Rectified Flow Matching
2025-07-28 07:16:01,620 - INFO -   ðŸš« Normalization: MINIMAL (only for evaluation similarity)
2025-07-28 07:16:01,620 - INFO - ================================================================================
2025-07-28 07:16:01,620 - INFO - ðŸ—ï¸ BLIP3-o ARCHITECTURE FEATURES:
2025-07-28 07:16:01,620 - INFO -   ðŸŒ 3D Rotary Position Embedding: âœ… ENABLED
2025-07-28 07:16:01,620 - INFO -   ðŸ¥ª Sandwich Normalization: âœ… ENABLED
2025-07-28 07:16:01,620 - INFO -   ðŸ” Grouped-Query Attention: âœ… ENABLED
2025-07-28 07:16:01,620 - INFO -   ðŸ“Š WandB Logging: âœ… ENABLED
2025-07-28 07:16:01,620 - INFO - ================================================================================
2025-07-28 07:16:01,620 - INFO - ðŸ“„ Updated file structure:
2025-07-28 07:16:01,620 - INFO -   â€¢ Model: blip3o_dit.py (âœ… 3D RoPE + Sandwich Norm)
2025-07-28 07:16:01,620 - INFO -   â€¢ Loss: blip3o_fm_loss.py
2025-07-28 07:16:01,620 - INFO -   â€¢ Dataset: blip3o_datasets.py
2025-07-28 07:16:01,620 - INFO -   â€¢ Trainer: blip3o_trainer.py (âœ… WandB Integration)
2025-07-28 07:16:01,620 - INFO -   â€¢ Config: blip3o_config.py
2025-07-28 07:16:01,621 - INFO - ================================================================================
2025-07-28 07:16:01,621 - INFO - Configuration:
2025-07-28 07:16:01,621 - INFO -   Model size: base
2025-07-28 07:16:01,621 - INFO -   Training mode: patch_only
2025-07-28 07:16:01,621 - INFO -   Embeddings dir: /scratch-shared/azadaianchuk1/blip3o_workspace/embeddings/patch_only_256_tokens
2025-07-28 07:16:01,621 - INFO -   Output dir: ./checkpoints/clip_repro_20250728_071559
2025-07-28 07:16:01,621 - INFO -   Learning rate: 0.0005
2025-07-28 07:16:01,621 - INFO -   Batch size: 16
2025-07-28 07:16:01,621 - INFO -   Epochs: 10
2025-07-28 07:16:01,621 - INFO -   Max shards: 2
2025-07-28 07:16:01,621 - INFO -   ðŸ§ª OVERFITTING TEST: 20 samples
2025-07-28 07:16:01,621 - INFO -   Debug mode: False
2025-07-28 07:16:01,621 - INFO -   ðŸ“Š WandB project: blip3o-clip-reproduction
2025-07-28 07:16:01,621 - INFO - ================================================================================
2025-07-28 07:16:01,621 - INFO - ðŸ” Checking module availability...
2025-07-28 07:16:04,987 - INFO - âœ… CLIP DiT model loaded from src/modules/models/blip3o_dit.py
2025-07-28 07:16:04,989 - INFO - âœ… Flow matching loss loaded from src/modules/losses/blip3o_fm_loss.py
2025-07-28 07:16:05,793 - INFO - âœ… CLIP trainer loaded from src/modules/trainers/blip3o_trainer.py
2025-07-28 07:16:05,794 - INFO - âœ… CLIP datasets loaded from src/modules/datasets/blip3o_dataset.py
2025-07-28 07:16:05,796 - INFO - âœ… Configuration loaded from src/modules/config/blip3o_config.py
2025-07-28 07:16:05,797 - INFO - ðŸŽ‰ All CLIP reproduction components loaded successfully!
2025-07-28 07:16:05,797 - INFO - ðŸŽ‰ BLIP3-o CLIP reproduction modules fully initialized!
2025-07-28 07:16:05,797 - INFO - ðŸš« Using minimal normalization approach
2025-07-28 07:16:05,797 - INFO - ðŸŽ¯ Ready for EVA â†’ CLIP reproduction training
2025-07-28 07:16:05,797 - INFO - âœ… Using comprehensive modules system
2025-07-28 07:16:05,797 - INFO - ðŸŽ‰ All CLIP reproduction components loaded successfully!
2025-07-28 07:16:05,797 - INFO - ðŸŽ‰ All CLIP reproduction components loaded successfully!
2025-07-28 07:16:05,797 - INFO - âœ… Imported config from src.modules
2025-07-28 07:16:06,552 - INFO - Using GPU: NVIDIA H100
2025-07-28 07:16:06,552 - INFO - GPU Memory: 100.0 GB
2025-07-28 07:16:06,552 - INFO - ðŸ—ï¸ BLIP3-o Architecture Configuration:
2025-07-28 07:16:06,552 - INFO -   3D Rotary Position Embedding: âœ… Enabled
2025-07-28 07:16:06,553 - INFO -   Sandwich Normalization: âœ… Enabled
2025-07-28 07:16:06,553 - WARNING - Failed to import from blip3o_dit.py: No module named 'blip3o_dit'
2025-07-28 07:16:06,553 - INFO - âœ… Imported model from src.modules
2025-07-28 07:16:08,589 - INFO - BLIP3-o CLIP DiT model initialized with 249,339,136 parameters
2025-07-28 07:16:08,589 - INFO -   3D RoPE: True
2025-07-28 07:16:08,589 - INFO -   Sandwich Normalization: True
2025-07-28 07:16:08,589 - INFO -   Grid size: 16x16
2025-07-28 07:16:08,590 - INFO -   Hidden size: 768
2025-07-28 07:16:08,590 - INFO -   CLIP size: 1024
2025-07-28 07:16:08,590 - INFO - Creating base model for patch_only mode...
2025-07-28 07:16:08,847 - INFO - Model created with 249,339,136 parameters
2025-07-28 07:16:08,848 - INFO - Model moved to cuda
2025-07-28 07:16:08,848 - INFO - ðŸ” Architecture Validation:
2025-07-28 07:16:08,848 - INFO -   3D RoPE: âœ…
2025-07-28 07:16:08,848 - INFO -   Sandwich Norm: âœ…
2025-07-28 07:16:08,848 - INFO -   Grid Size: 16x16
2025-07-28 07:16:08,848 - INFO -   Grouped-Query Attention: 12/4
2025-07-28 07:16:08,848 - WARNING - Failed to import from blip3o_fm_loss.py: No module named 'blip3o_fm_loss'
2025-07-28 07:16:08,848 - INFO - âœ… Imported loss from src.modules
2025-07-28 07:16:08,848 - INFO - CLIP Flow Matching Loss initialized:
2025-07-28 07:16:08,848 - INFO -   Prediction type: velocity
2025-07-28 07:16:08,849 - INFO -   Flow type: rectified
2025-07-28 07:16:08,849 - INFO -   Loss weight: 1.0
2025-07-28 07:16:08,849 - INFO -   Debug mode: False
2025-07-28 07:16:08,849 - INFO - Flow matching loss created
2025-07-28 07:16:08,849 - WARNING - Failed to import from blip3o_datasets.py: No module named 'blip3o_datasets'
2025-07-28 07:16:08,849 - INFO - âœ… Imported dataset from src.modules
2025-07-28 07:16:08,849 - INFO - Creating CLIP reproduction dataloaders:
2025-07-28 07:16:08,849 - INFO -   Target: CLIP embeddings [B, N, 1024]
2025-07-28 07:16:08,849 - INFO -   Conditioning: EVA embeddings [B, N, 4096]
2025-07-28 07:16:08,849 - INFO -   Normalize: False
2025-07-28 07:16:08,873 - INFO - Loaded manifest: 35 shards, 91,333 samples
2025-07-28 07:16:08,874 - INFO - Found 35 files with pattern: embeddings_shard_*_patch_only.pkl
2025-07-28 07:16:08,874 - INFO - Prepared 2 shard files
2025-07-28 07:16:08,874 - INFO - Using manifest for length estimation: 5,219 samples
2025-07-28 07:16:08,874 - INFO - CLIP Reproduction Dataset initialized:
2025-07-28 07:16:08,874 - INFO -   Directory: /scratch-shared/azadaianchuk1/blip3o_workspace/embeddings/patch_only_256_tokens
2025-07-28 07:16:08,874 - INFO -   Mode: patch_only (256 tokens)
2025-07-28 07:16:08,874 - INFO -   TARGET: CLIP embeddings [B, N, 1024]
2025-07-28 07:16:08,874 - INFO -   CONDITIONING: EVA embeddings [B, N, 4096]
2025-07-28 07:16:08,874 - INFO -   Normalize: False
2025-07-28 07:16:08,874 - INFO -   Shards: 2
2025-07-28 07:16:08,874 - INFO -   Estimated samples: 5,219
2025-07-28 07:16:08,875 - INFO - Loaded manifest: 35 shards, 91,333 samples
2025-07-28 07:16:08,875 - INFO - Found 35 files with pattern: embeddings_shard_*_patch_only.pkl
2025-07-28 07:16:08,875 - INFO - Prepared 2 shard files
2025-07-28 07:16:08,875 - INFO - Using manifest for length estimation: 5,219 samples
2025-07-28 07:16:08,875 - INFO - CLIP Reproduction Dataset initialized:
2025-07-28 07:16:08,875 - INFO -   Directory: /scratch-shared/azadaianchuk1/blip3o_workspace/embeddings/patch_only_256_tokens
2025-07-28 07:16:08,875 - INFO -   Mode: patch_only (256 tokens)
2025-07-28 07:16:08,875 - INFO -   TARGET: CLIP embeddings [B, N, 1024]
2025-07-28 07:16:08,876 - INFO -   CONDITIONING: EVA embeddings [B, N, 4096]
2025-07-28 07:16:08,876 - INFO -   Normalize: False
2025-07-28 07:16:08,876 - INFO -   Shards: 2
2025-07-28 07:16:08,876 - INFO -   Estimated samples: 5,219
2025-07-28 07:16:08,876 - INFO - CLIP reproduction dataloaders created successfully
2025-07-28 07:16:08,876 - INFO -   Training dataset length: 5,219
2025-07-28 07:16:08,876 - INFO -   Evaluation dataset length: 5,219
2025-07-28 07:16:08,876 - INFO - Dataloaders created
2025-07-28 07:16:08,876 - INFO -   Training batches: 326
2025-07-28 07:16:08,876 - INFO -   Evaluation available: True
2025-07-28 07:16:08,876 - INFO -   ðŸš« Normalization disabled in dataloaders
2025-07-28 07:16:08,877 - WARNING - Failed to import from blip3o_trainer.py: No module named 'blip3o_trainer'
2025-07-28 07:16:08,877 - INFO - âœ… Imported trainer from src.modules
2025-07-28 07:16:08,880 - INFO - Got exact dataloader length: 326
2025-07-28 07:16:08,881 - INFO - Optimizer and scheduler setup complete
2025-07-28 07:16:08,881 - INFO -   Total estimated steps: 3260
2025-07-28 07:16:08,881 - INFO -   Warmup steps: 100
2025-07-28 07:16:10,357 - INFO - âœ… WandB initialized: blip3o-clip-reproduction
2025-07-28 07:16:10,358 - INFO -    Run ID: 00d0di5i
2025-07-28 07:16:10,358 - INFO -    Run URL: https://wandb.ai/Eva-Clip/blip3o-clip-reproduction/runs/00d0di5i
2025-07-28 07:16:10,358 - INFO - Preparing overfitting test with 20 samples...
2025-07-28 07:16:14,847 - INFO - Loaded shard 1/2: 2601 samples
2025-07-28 07:16:14,928 - INFO - Overfitting test prepared with 16 samples
2025-07-28 07:16:14,928 - INFO - BLIP3-o CLIP Trainer initialized
2025-07-28 07:16:14,929 - INFO -   Device: cuda
2025-07-28 07:16:14,929 - INFO -   Learning rate: 0.0005
2025-07-28 07:16:14,929 - INFO -   Epochs: 10
2025-07-28 07:16:14,929 - INFO -   Estimated steps per epoch: 326
2025-07-28 07:16:14,929 - INFO -   Overfit test: 20
2025-07-28 07:16:14,929 - INFO -   Mixed precision: True
2025-07-28 07:16:14,929 - INFO -   WandB logging: True
2025-07-28 07:16:14,929 - INFO -   ðŸš« Minimal normalization: Only for evaluation similarity
2025-07-28 07:16:14,929 - INFO - Trainer created with WandB integration
2025-07-28 07:16:14,929 - INFO -   ðŸ“Š WandB enabled: True
2025-07-28 07:16:14,929 - INFO -   ðŸ“Š WandB project: blip3o-clip-reproduction
2025-07-28 07:16:14,929 - INFO -   ðŸ“Š WandB run name: blip3o_base_patch_only_3drope_sandwich_20250728_071608
2025-07-28 07:16:14,929 - INFO -   ðŸ“Š WandB tags: ['blip3o', 'clip_reproduction', 'eva_conditioning', '3d_rope', 'sandwich_norm', 'overfit_test']
2025-07-28 07:16:14,932 - INFO - Configuration saved to checkpoints/clip_repro_20250728_071559/experiment_config.json
2025-07-28 07:16:14,932 - INFO - 
ðŸš€ Starting BLIP3-o training with advanced features...
2025-07-28 07:16:14,932 - INFO - Expected behavior:
2025-07-28 07:16:14,932 - INFO -   â€¢ Loss should decrease steadily
2025-07-28 07:16:14,932 - INFO -   â€¢ Velocity similarity should increase
2025-07-28 07:16:14,932 - INFO -   â€¢ CLIP similarity should improve during evaluation
2025-07-28 07:16:14,932 - INFO -   â€¢ Gradients should be non-zero and stable
2025-07-28 07:16:14,932 - INFO -   â€¢ Raw embeddings will be learned (no forced normalization)
2025-07-28 07:16:14,932 - INFO -   â€¢ 3D RoPE should provide spatial understanding
2025-07-28 07:16:14,932 - INFO -   â€¢ Sandwich normalization should improve gradient flow
2025-07-28 07:16:14,932 - INFO -   â€¢ WandB should log comprehensive metrics
2025-07-28 07:16:14,932 - INFO -   â€¢ OVERFITTING TEST: Should achieve >0.8 similarity on 20 samples
2025-07-28 07:16:14,932 - INFO - 
2025-07-28 07:16:14,932 - INFO - Starting CLIP reproduction training with WandB...
2025-07-28 07:16:14,934 - INFO -   Model parameters: 249,339,136
2025-07-28 07:16:14,934 - INFO -   Estimated training steps per epoch: 326
2025-07-28 07:16:14,934 - INFO -   Total estimated training steps: 3260
2025-07-28 07:16:14,934 - INFO -   ðŸš« Minimal normalization: Only for evaluation similarity
2025-07-28 07:16:14,934 - INFO -   ðŸ“Š WandB logging: True
2025-07-28 07:16:14,934 - INFO -   OVERFITTING TEST MODE: Using 16 samples
2025-07-28 07:16:14,937 - INFO - Starting epoch 1/10
2025-07-28 07:16:19,102 - INFO - Loaded shard 1/2: 2601 samples
2025-07-28 07:16:23,861 - INFO - Step 10: Loss=1.817616, VelSim=0.3614 (fair), GradNorm=23596.249, LR=9.50e-05, PredNorm=13.373, TargetNorm=42.468 [OVERFIT TEST]
2025-07-28 07:16:27,790 - INFO - Step 20: Loss=1.738301, VelSim=0.3936 (fair), GradNorm=19698.126, LR=1.40e-04, PredNorm=16.754, TargetNorm=42.468 [OVERFIT TEST]
2025-07-28 07:16:31,682 - INFO - Step 30: Loss=1.666756, VelSim=0.4194 (fair), GradNorm=20985.530, LR=1.85e-04, PredNorm=18.396, TargetNorm=42.468 [OVERFIT TEST]
2025-07-28 07:16:35,586 - INFO - Step 40: Loss=1.612415, VelSim=0.4197 (fair), GradNorm=42475.989, LR=2.30e-04, PredNorm=17.015, TargetNorm=42.468 [OVERFIT TEST]
2025-07-28 07:16:39,494 - INFO - Step 50: Loss=1.538619, VelSim=0.3941 (fair), GradNorm=95605.517, LR=2.75e-04, PredNorm=22.563, TargetNorm=42.468 [OVERFIT TEST]
2025-07-28 07:16:39,495 - INFO - Running evaluation at step 50...
2025-07-28 07:16:44,494 - INFO - Loaded shard 1/2: 2646 samples
2025-07-28 07:20:36,482 - INFO - Evaluation results (similarity uses normalization):
2025-07-28 07:20:36,484 - INFO -   eval_clip_similarity: 0.2375
2025-07-28 07:20:36,484 - INFO -   eval_clip_similarity_std: 0.0175
2025-07-28 07:20:36,484 - INFO -   eval_clip_similarity_min: 0.1925
2025-07-28 07:20:36,484 - INFO -   eval_clip_similarity_max: 0.3083
2025-07-28 07:20:36,484 - INFO -   eval_mse_loss: 1.8622
2025-07-28 07:20:36,484 - INFO -   eval_mse_loss_std: 0.1038
2025-07-28 07:20:36,484 - INFO -   eval_high_quality: 0.0000
2025-07-28 07:20:36,484 - INFO -   eval_very_high_quality: 0.0000
2025-07-28 07:20:36,484 - INFO -   eval_excellent_quality: 0.0000
2025-07-28 07:20:36,484 - INFO -   eval_samples: 512.0000
2025-07-28 07:20:36,484 - INFO -   eval_time_seconds: 236.9848
2025-07-28 07:20:36,484 - INFO -   eval_samples_per_second: 2.1605
2025-07-28 07:20:40,355 - INFO - Step 60: Loss=1.413314, VelSim=0.4227 (fair), GradNorm=60123.533, LR=3.20e-04, PredNorm=22.064, TargetNorm=42.468 [OVERFIT TEST]
2025-07-28 07:20:44,279 - INFO - Step 70: Loss=1.345257, VelSim=0.4445 (fair), GradNorm=41701.242, LR=3.65e-04, PredNorm=21.693, TargetNorm=42.468 [OVERFIT TEST]
2025-07-28 07:20:48,178 - INFO - Step 80: Loss=1.273064, VelSim=0.4887 (fair), GradNorm=21624.876, LR=4.10e-04, PredNorm=21.557, TargetNorm=42.468 [OVERFIT TEST]
2025-07-28 07:20:52,019 - INFO - Step 90: Loss=1.273343, VelSim=0.4906 (fair), GradNorm=46292.902, LR=4.55e-04, PredNorm=19.677, TargetNorm=42.468 [OVERFIT TEST]
2025-07-28 07:20:55,896 - INFO - Step 100: Loss=1.142025, VelSim=0.5617 (good), GradNorm=31746.157, LR=5.00e-04, PredNorm=24.706, TargetNorm=42.468 [OVERFIT TEST]
2025-07-28 07:20:55,896 - INFO - Running evaluation at step 100...
2025-07-28 07:21:00,492 - INFO - Loaded shard 1/2: 2646 samples
2025-07-28 07:24:51,747 - INFO - Evaluation results (similarity uses normalization):
2025-07-28 07:24:51,751 - INFO -   eval_clip_similarity: 0.2334
2025-07-28 07:24:51,751 - INFO -   eval_clip_similarity_std: 0.0195
2025-07-28 07:24:51,751 - INFO -   eval_clip_similarity_min: 0.1804
2025-07-28 07:24:51,751 - INFO -   eval_clip_similarity_max: 0.3210
2025-07-28 07:24:51,751 - INFO -   eval_mse_loss: 1.8726
2025-07-28 07:24:51,752 - INFO -   eval_mse_loss_std: 0.1038
2025-07-28 07:24:51,752 - INFO -   eval_high_quality: 0.0000
2025-07-28 07:24:51,752 - INFO -   eval_very_high_quality: 0.0000
2025-07-28 07:24:51,752 - INFO -   eval_excellent_quality: 0.0000
2025-07-28 07:24:51,752 - INFO -   eval_samples: 512.0000
2025-07-28 07:24:51,752 - INFO -   eval_time_seconds: 235.8493
2025-07-28 07:24:51,752 - INFO -   eval_samples_per_second: 2.1709
2025-07-28 07:24:55,623 - INFO - Step 110: Loss=0.984398, VelSim=0.6386 (good), GradNorm=38236.327, LR=5.00e-04, PredNorm=27.981, TargetNorm=42.468 [OVERFIT TEST]
2025-07-28 07:24:59,516 - INFO - Step 120: Loss=0.828988, VelSim=0.7092 (good), GradNorm=46874.224, LR=5.00e-04, PredNorm=30.111, TargetNorm=42.468 [OVERFIT TEST]
2025-07-28 07:25:03,359 - INFO - Step 130: Loss=0.656660, VelSim=0.7809 (good), GradNorm=30937.016, LR=5.00e-04, PredNorm=33.740, TargetNorm=42.468 [OVERFIT TEST]
2025-07-28 07:25:07,230 - INFO - Step 140: Loss=0.523756, VelSim=0.8318 (excellent), GradNorm=36236.727, LR=5.00e-04, PredNorm=35.509, TargetNorm=42.468 [OVERFIT TEST]
2025-07-28 07:25:11,096 - INFO - Step 150: Loss=0.434321, VelSim=0.8639 (excellent), GradNorm=38037.200, LR=5.00e-04, PredNorm=36.809, TargetNorm=42.468 [OVERFIT TEST]
2025-07-28 07:25:11,097 - INFO - Running evaluation at step 150...
2025-07-28 07:25:16,161 - INFO - Loaded shard 1/2: 2646 samples
